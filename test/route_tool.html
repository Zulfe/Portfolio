<!DOCTYPE html>

<html>
    <head>
        <link rel="stylesheet" type="text/css" href="route_tool.css">
        <script src="jquery.min.js"></script>
        <title>Route Building Tool</title>
    </head>


    <body>
        <div id="toolbar">

            <div id="zone_1">Zone 1</div>

            <div id="zone_2">Zone 2</div>

            <div id="zone_3">Zone 3</div>

            <div id="zone_4">Zone 4</div>

            <div id="zone_5">Zone 5</div>

            <div id="zone_6">Zone 6</div>

            <div id="plot">Plot Route</div>

            <div id="done">Write Route</div>

            <div id="clear">Clear</div>

            <div id="export">Export</div>

            <div class="mvt_ids" id="SBL">SBL</div class="mvt_ids">

            <div class="mvt_ids" id="SBT">SBT</div class="mvt_ids">

            <div class="mvt_ids" id="SBR">SBR</div class="mvt_ids">

            <div class="mvt_ids" id="WBL">WBL</div class="mvt_ids">

            <div class="mvt_ids" id="WBT">WBT</div class="mvt_ids">

            <div class="mvt_ids" id="WBR">WBR</div class="mvt_ids">

            <div class="mvt_ids" id="NBL">NBL</div class="mvt_ids">

            <div class="mvt_ids" id="NBT">NBT</div class="mvt_ids">

            <div class="mvt_ids" id="NBR">NBR</div class="mvt_ids">

            <div class="mvt_ids" id="EBL">EBL</div class="mvt_ids">

            <div class="mvt_ids" id="EBT">EBT</div class="mvt_ids">

            <div class="mvt_ids" id="EBR">EBR</div class="mvt_ids">
            
            <div id="terminal">Terminal: </div>
        </div>

        <div id="canvas">

        </div>

    </body>


    <script>
        $(document).ready(function(){

            //var volumesEntered = false;
            var zoneDrawEnabled = false;
            var plotModeEnabled = false;

            var numClicks = 0;

            var intervals = [];

            var plottingStarted = false;

            var routeNumber = 0;
            var lastAtRouteNumber = 0;
            var lastAtColor;
            var routeEnum = {
                "0" : "Southbound Left",
                "1" : "Southbound Through",
                "2" : "Southbound Right",
                "3" : "Westbound Left",
                "4" : "Westbound Through",
                "5" : "Westbound Right",
                "6" : "Northbound Left",
                "7" : "Northbound Through",
                "8" : "Northbound Right",
                "9" : "Eastbound Left",
                "10" : "Eastbound Through",
                "11" : "Eastbound Right"
            }
            var routeIDEnum = {
                "0" : "SBL",
                "1" : "SBT",
                "2" : "SBR",
                "3" : "WBL",
                "4" : "WBT",
                "5" : "WBR",
                "6" : "NBL",
                "7" : "NBT",
                "8" : "NBR",
                "9" : "EBL",
                "10" : "EBT",
                "11" : "EBR"
            }
            var routeAddressEnum = {
                "0" : [0, 0, 0],
                "1" : [0, 0, 1],
                "2" : [0, 0, 2],
                "3" : [0, 1, 0],
                "4" : [0, 1, 1],
                "5" : [0, 1, 2],
                "6" : [0, 2, 0],
                "7" : [0, 2, 1],
                "8" : [0, 2, 2],
                "9" : [0, 3, 0],
                "10" : [0, 3, 1],
                "11" : [0, 3, 2]
            }


            var zoneDrawNumber  = 0;
            var zonesDrawn = [false, false, false, false, false, false];

            var currentRoute = [];
            var totalRoutes = [];

            var updateTerminal = function(message) {
                $("#terminal").html("Terminal: &nbsp;&nbsp;&nbsp;" + message);
            }

            /**
            * Allow for the creation of zone block elements on the canvas. Prevents plotting when a user clicks an arrow image.
            * @param {int} zone_id The identification number of the zone to be drawn. This number is between 1 and 6.
            */
            var enableZoneDraw = function(zone_id) {
                plotModeEnabled = false;
                zoneDrawEnabled = true;
                zoneDrawNumber = zone_id;
            }

            /**
            * Allow for the selection of arrow images for compiling route arrays. If no plotting has been done yet, initiate the
            * plotting process.
            *
            */
            var enablePlotMode = function() {
                zoneDrawEnabled = false;
                plotModeEnabled = true;

                if(!plottingStarted) {
                    $("#" + routeIDEnum[(0).toString()]).css("background-color", "yellow");
                    updateTerminal("Now recording a route that enters through the Southbound Left!");
                    currentRoute.push([0, 0, 0]);
                    plottingStarted = true;
                }
            }

            /**
            *
            *
            */
            var clearCanvas = function() {
                $("#canvas").children().remove();
                zonesDrawn = [false, false, false, false, false, false];
                updateTerminal("The canvas has been cleared");
                numClicks = 0;
            }

            /**
            *
            *
            */
            var flashArrow = function(arrow_elem) {
                var int = setInterval(function() {
                    if($(arrow_elem).css("background-color") == "rgb(255, 165, 0)") {
                        $(arrow_elem).css("background-color", "blue");
                    }
                    else {
                        $(arrow_elem).css("background-color", "orange");
                    }
                }, 400);
                $(arrow_elem).data("interid", int.toString());
                intervals.push(int);
            }

            var resetArrow = function(arrow_elem, interid) {
                clearInterval(interid);
                $(arrow_elem).css("background-color", "black");
            }

            /**
            *
            *
            */
            var resetArrows = function() {
                intervals.forEach(function(interval, index) {
                    clearInterval(interval); 
                });
                intervals = [];
                $(".zone_block img").css({
                    "background-color" : "black",
                    "visibility" : "visible"
                });
            }

            /**
            *
            *
            */
            var objectKeyByValue = function(obj, val) {
                  return Object.entries(obj).find(i => i[1] === val)[0];
            }
            
            /**
            *
            *
            */
            var saveRoute = function() {
                if(routeNumber < 12) {
                    updateTerminal(routeEnum[routeNumber.toString()] + " has been recorded. Now recording " + routeEnum[(routeNumber + 1).toString()] + ".");
                    $("#" + routeIDEnum[routeNumber]).css("background-color", "#94B95B");
                    $("#" + routeIDEnum[routeNumber + 1]).css("background-color", "yellow");
                    totalRoutes.push(currentRoute);
                    currentRoute = [];
                    routeNumber = routeNumber + 1;
                    lastAtRouteNumber = lastAtRouteNumber + 1;
                    currentRoute.push(routeAddressEnum[routeNumber.toString()]);

                    resetArrows();
                }
                else
                    updateTerminal("All routes have been written. Please export!");

                console.log(totalRoutes);

            }

            /**
            *
            *
            */
            var loadRoute = function(moveToRoute) {
                if(totalRoutes.length < 2) {
                    updateTerminal("You must first create route configurations before swapping between them.");
                    return;
                }
                console.log("I was previously at entrance ID " + lastAtRouteNumber);
                console.log($("#" + routeIDEnum[lastAtRouteNumber]));
                $("#" + routeIDEnum[lastAtRouteNumber]).css("background-color", "#CCCCCC");
                $("#" + routeIDEnum[moveToRoute]).css("background-color", "yellow");
                lastAtRouteNumber = moveToRoute;
                resetArrows();
                var route = totalRoutes[moveToRoute];

                route.forEach(function(mvts, index) {
                    if(mvts[0] == 0)
                        return;
                    flashArrow($(".zone_block[data-zone='" + mvts[0] +"'] div[data-dir='" + mvts[1] + "'] img[data-mvt='" + mvts[2] + "']"));
                });
                
            }

            /**
            *
            *
            */
            var exportToCSV = function() {
                if(totalRoutes.length != 12) {
                    updateTerminal("You haven't completed all twelve movements for this configuration.");
                    return;
                }

                var headers = ["route", "zone", "dir", "mvt", "o_zone", "o_dir", "o_mvt"];
                var csvContent = "data:text/csv;charset=utf-8,";

                headers.forEach(function(header, index){
                    csvContent += index < headers.length - 1  ? header + "," : header + "\n"
                });
               
                for(var route = 0; route < totalRoutes.length; route++) {
                    for(var node = 0; node < totalRoutes[route].length; node++) {
                        csvContent += route + 1;
                        csvContent += ", " + totalRoutes[route][node][0] + ", " + totalRoutes[route][node][1] + ", " + totalRoutes[route][node][2];
                        if(node != 0)
                            csvContent += ", " + totalRoutes[route][node - 1][0] + ", " + totalRoutes[route][node - 1][1] + ", " + totalRoutes[route][node - 1][2];
                        else
                            csvContent += ", " + -1 + ", " + -1 + ", " + -1;
                        csvContent += "\n";
                    }
                }


                var filename = prompt("Please define a filename.");
                if(filename === undefined || filename == "null")
                    filename = "int_X_routesconf";

                var csvURI = encodeURI(csvContent);

                // Create a link on the page, link the CSV to it, mark it as a possible download, then click it for the user.
                var link = document.createElement("a");
                link.setAttribute("href", csvURI);
                link.setAttribute("download", filename + ".csv");
                document.body.appendChild(link);-
                link.click();
            }

            /**
            *
            *
            */
            $(".mvt_ids").click(function() {
                var elem_id = $(this).attr("id");
                loadRoute(parseInt(objectKeyByValue(routeIDEnum, elem_id)));
            });

            /**
            *
            *
            */
            $("#toolbar div").click(function(){
                var button_id = $(this).text();

                if(button_id == "Zone 1")
                    enableZoneDraw(1);
                
                if(button_id == "Zone 2")
                    enableZoneDraw(2);
                
                if(button_id == "Zone 3")
                    enableZoneDraw(3);
                
                if(button_id == "Zone 4")
                    enableZoneDraw(4); 

                if(button_id == "Zone 5")
                    enableZoneDraw(5);
                
                if(button_id == "Zone 6")
                    enableZoneDraw(6);
               
                if(button_id == "Plot Route")
                    enablePlotMode();

                if(button_id == "Write Route")
                    saveRoute();

                if(button_id == "Clear")
                    clearCanvas();

                if(button_id == "Export")
                    exportToCSV();


                if($(this).attr("id") == "terminal")
                    return;

            });

            var relX = 0;
            var relY = 0;

            /**
            *
            *
            */
            $("#canvas").mousemove(function(mouseevent) {
                relX = mouseevent.pageX;
                relY = mouseevent.pageY;
            });

            /**
            *
            *
            */
            $(document).on("click", "img", function() {
                /*
                * Error Control
                */
                // If plot mode isn't active, don't allow arrows to be activated.
                if(!plotModeEnabled)
                    return;

                /*
                * NEED TO REMOVE ENTRY FROM ARRY WHEN AN ARROW IS DISABLED!!!!!!!!!!!!!!!!!!!!!!!!!!!
                *
                ************************************************/

                // If there is an arrow already active in this zone, don't allow another arrow to become activated.
                if($(this).parent().parent().parent().data("active-arrows") == "1") {
                    if($(this).data("active") == "1") {
                        $(this).data("active", "0");
                        $(this).parent().parent().parent().data("active-arrows", "0");
                        resetArrow(this, $(this).data("interid"));
                    }
                    else {
                        updateTerminal("A movement arrow for this zone is already active.");
                        return;
                    }
                }
                // If there isn't one active, increment the number of active arrows.
                else {
                    $(this).parent().parent().parent().data("active-arrows", "1");
                    $(this).data("active", "1");
                }


                mvt = $(this).data("mvt");
                dir = $(this).parent().parent().data("dir");
                zone = $(this).parent().parent().parent().data("zone");
              
                flashArrow($(this));

                console.log("Adding ["  + zone + ", " + dir + ", " + mvt + "] to list of current routes.");
                currentRoute.push([zone, dir, mvt]);

            });

            /**
            *
            *
            */
            $("#canvas").click(function(e) {
               /* if(!volumesEntered) {
                    updateTerminal("You haven't entered any input volumes yet.");
                    return;
                }*/
                if(!zoneDrawEnabled)
                    return;
                // If a zone to draw has been clicked, allow a zone to be drawn.
                if(zoneDrawEnabled) {
                    if(!zonesDrawn[zoneDrawNumber - 1]) {
                        numClicks++;
                        var UID = Math.random().toString(36).substring(2,5);
                        var zone_block_html =
"                        <div id='" + UID + "' class='zone_block' style='visibility: hidden;' data-zone='" + zoneDrawNumber + "' data-active-arrows='0'>" +
"                            <div class='top_arrows' data-dir='0'>" +
"                                <div class='imggrp'>" +
"                                    <img data-mvt='0' data-active='0' data-interid='-1' src='arrow_left.svg' />" +
"                                    <img data-mvt='1' data-active='0' data-interid='-1' class='through' src='arrow_through.svg' />" +
"                                    <img data-mvt='2' data-active='0' data-interid='-1' src='arrow_right.svg' />" +
"                                </div>" +
"                            </div>" +
"                            <div class='left_arrows' data-dir='3'>" +
"                                <div class='imggrp'>" +
"                                    <img data-mvt='0' data-active='0' data-interid='-1' src='arrow_left.svg' />" +
"                                    <img data-mvt='1' data-active='0' data-interid='-1' class='through' src='arrow_through.svg' />" +
"                                    <img data-mvt='2' data-active='0' data-interid='-1' src='arrow_right.svg' />" +
"                                </div>" +
"                            </div>" +
"                            <div class='bot_arrows' data-dir='2'>" +
"                                <div class='imggrp'>" +
"                                    <img data-mvt='0' data-active='0' data-interid='-1' src='arrow_left.svg' />" +
"                                    <img data-mvt='1' data-active='0' data-interid='-1' class='through' src='arrow_through.svg' />" +
"                                    <img data-mvt='2' data-active='0' data-interid='-1' src='arrow_right.svg' />" +
"                                </div>" +
"                            </div>" +
"                            <div class='right_arrows' data-dir='1'>" +
"                                <div class='imggrp'>" +
"                                    <img data-mvt='0' data-active='0' data-interid='-1' src='arrow_left.svg' />" +
"                                    <img data-mvt='1' data-active='0' data-interid='-1' class='through' src='arrow_through.svg' />" +
"                                    <img data-mvt='2' data-active='0' data-interid='-1' src='arrow_right.svg' />" +
"                                </div>" +
"                            </div>" +
"                            <div class='zone_num'>" +
"                                " + zoneDrawNumber +
"                            </div>" +
"                        </div>";
                
                        

                        $("#canvas").append(zone_block_html);
                         

                        $("#" + UID).css({
                            position: 'relative',
                            left: relX - 85,
                            top: "calc(" + relY + "px - " + numClicks + " * 10.5em)"
                        });

                        $("#" + UID).css("visibility", "visible");

                        zonesDrawn[zoneDrawNumber - 1] = true;
                    }
                    else
                        updateTerminal("You cannot draw multiples of Zone " + zoneDrawNumber);
                }
                else
                    updateTerminal("No zone has been selected to draw.");
            });
        });
    </script>

</html>
